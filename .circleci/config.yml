# This code is licensed from CircleCI to the user under the MIT license.
# See here for details: https://circleci.com/developer/orbs/licensing
---
version: 2.1
description: |
    Run load tests and reliability tests using DM.
    source_url: https://github.com/dmtest2/circleci.git

commands:
    login:
        description: |
            Login
        parameters:
            uid:
                default: ""
                description: Client UID to login to DM API
                type: string
            stress_id:
                default: ""
                description: Stress test ID
                type: string
        steps:
            #- run: mkdir -p workspace
            #- run: echo "Workspace directory has been created"
            - run:
                name: Login to API
                command: |
                    export ST_ID="<< parameters.stress_id >>"
                    echo "export ST_ID=\"$ST_ID\"" >> env.vars
                    curl -X POST https://api.dotcom-monitor.com/config_api_v1/LogIn \
                        --cookie-jar dm.auth -v \
                        -H "Content-Type: application/json" \
                        -d '{ "UID" : "<< parameters.uid >>" }'

            - persist_to_workspace:
                root: .
                paths:
                    - .

    get_stress:
        steps:
            - attach_workspace:
                at: .
            - run:
                name: Get Stress Test details
                command: |
                    source env.vars    
                    curl -X GET https://api.dotcom-monitor.com/config_api_v1/StressTest/$ST_ID \
                        --cookie dm.auth \
                        -H "Content-Type: application/json"

    #run_stress:
    #    description: Start Stress
    #    steps:
    #        - attach_workspace:
    #            at: .
    #        - run:
    #            name: Run Stress Test
    #            command: |
    #                source .      
    #                curl -X POST https://api.dotcom-monitor.com/config_api_v1/StressTest/$ST_ID/Run \
    #                    --cookie dm.auth \
    #                    -H "Content-Type: application/json" \
    #                    -d '{ "UserName": "user" }'

jobs:
  build:
    docker:
      - image: cimg/base:current
    #resource_class: dmtest2/rc2
    steps:
      #- checkout
      - run: echo "this is the build job"
  login_via_api:
    docker:
      - image: cimg/base:current
    #resource_class: dmtest2/rc2
    steps:
      - login:
          uid: "ee4b1545c7064b0f84c446e5a6e34832"
          stress_id: "15000"
      - run: echo "login done"
  get_st:
    docker:
      - image: cimg/base:current
    steps:
      - get_stress
      - run: echo "stress test getting details"
  #start:
  #  docker:
  #    - image: cimg/base:current
  #  steps:
  #    - run_stress
  #    - run: echo "stress test << parameters.stress_id >> starting"  

# Orchestrate our job run sequence
workflows:
  build_and_test:
    jobs:
      - build
      - login_via_api:
          requires:
            - build
      - get_st:
          requires:
            - login_via_api
      #- start:
      #    requires:
      #      - get_st